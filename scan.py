import sys
import numpy as np
import itertools
import operator
import matplotlib.pyplot as plt

from keras.models import model_from_json

import train
import datahandler as dh


def exe_vector_to_matrix(exe_vector, byte_series=16):
    exe_matrix = []
    exe_vector_len = len(exe_vector)
    for i in range(exe_vector_len):
        if len(exe_vector[i:i+byte_series]) == byte_series:
            exe_matrix.append(exe_vector[i:i+byte_series])

    return np.array(exe_matrix)


def load_model():

    json_path = "model.json"
    h5_path = "model.h5"
    
    json_file = open(json_path, "r")
    model_json = json_file.read()
    json_file.close()
    model = model_from_json(model_json)
    model.load_weights(h5_path)
    model = train.compile_model(model, loss="binary_crossentropy")
    print("Loaded existing model: {}, {}".format(json_path, h5_path))

    return model


def find_longest_sequence(A, value=1):
    count = 0
    prev = 0
    indexend = 0
    for i in range(0, len(A)):
        if A[i] == value:
            count += 1
        else:
            if count > prev:
                prev = count
                indexend = i
            count = 0

    return prev
    



if __name__ == "__main__":
    model = load_model()
    filepath = sys.argv[1]
    exe_vector = dh.exe_to_vector(filepath)
    byte_matrix = exe_vector_to_matrix(exe_vector)
    preds = model.predict(byte_matrix, verbose=1)
    preds = list(map(lambda x: int(round(x[0])), preds))


    #plt.plot(preds)
    #plt.show()

    print(find_longest_sequence(preds))
    print(preds.count(1))
    print(preds.count(1) / len(preds))