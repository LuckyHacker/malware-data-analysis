import numpy as np
import matplotlib.pyplot as plt
import os
import sys
import scipy.fftpack
import pandas as pd

from PIL import Image

import memoryleak


def normalize(arr):
    arr = list(arr)
    min_value = min(arr)
    max_value = max(arr)

    new_arr = []
    for value in arr:

        if str(value) == "nan":
            new_arr.append(value)
            continue

        new_arr.append((value - min_value) / (max_value - min_value))

    return new_arr


def denormalize(norm_value, orig_arr):
    norm_value = float(norm_value)
    arr = list(orig_arr)
    min_value = min(arr)
    max_value = max(arr)

    value = min_value + ((max_value - min_value) * norm_value)
    return value


def pair_safe_and_malware(basepath="data/"):
    safepath = os.path.join(basepath, "safe")
    malwarepath = os.path.join(basepath, "malware")

    safepaths = os.listdir(safepath)
    malwarepaths = os.listdir(malwarepath)

    pair_paths = []

    for mpath in malwarepaths:
        identifier = mpath.split("_")[0]
        for spath in safepaths:
            if identifier in spath:
                pair_paths.append([spath, mpath])
                break

    return pair_paths


def exe_to_vector(path):
    with open(path, "rb") as f:
        data = str(f.read(), "latin-1")

    return np.array(list(map(lambda c: ord(c), data)))


def compare_vectors(v1, v2, outpath="safe_vs_malware.png", label_v1="safe", label_v2="malware"):
    plt.figure(figsize=(17,9))
    plt.hist(v1, bins=200, label=label_v1)
    plt.hist(v2, bins=200, label=label_v2)
    plt.legend(loc="upper right")
    plt.savefig(outpath)


def compare_all_safe_vs_malware():
    exe_pairs = pair_safe_and_malware()

    for pair in exe_pairs:
        exe_vector = normalize(exe_to_vector("data/safe/{}".format(pair[0])))
        exe_vector_injected = normalize(exe_to_vector("data/malware/{}".format(pair[1])))
        compare_vectors(exe_vector, exe_vector_injected, outpath="images/{}_vs_{}.png".format(pair[0], pair[1]))


def files_difference_as_csv():

    exe_pairs = pair_safe_and_malware()

    for pair in exe_pairs:
        print(pair)
        safe = normalize(exe_to_vector("data/safe/{}".format(pair[0])))
        malware = normalize(exe_to_vector("data/malware/{}".format(pair[1])))

        diff_count = 0
        size_count = 0
        with open("data/differences/{}_vs_{}.csv".format(pair[0], pair[1]), "w") as f:
            for s, m in zip(safe, malware):
                for _ in range(1024):
                    if s != m:
                        diff_count += 1

                    size_count += 1

                sys.stdout.write("\r{} %{}".format(round(diff_count / size_count * 100, 2), " "*20))
                f.write(str(diff_count / size_count * 100) + ",")
        
        print("")
        print("Difference percent between {} and {}: {} %".format(pair[0], pair[1], diff_count / size_count * 100))



def plot_differences():
    basepath = "data/differences"

    filenames = os.listdir(basepath)

    for filename in filenames:
        path = os.path.join(basepath, filename)
        with open(path, "r") as f:
            difference_percents = list(map(lambda x: float(x), filter(lambda x: x != "", f.read().split(","))))

        plt.figure(figsize=(18,9))
        plt.title("Difference between original and injected file")
        plt.plot(difference_percents)
        plt.savefig("images/differences/{}.png".format(filename))



if __name__ == "__main__":
    #compare_all_safe_vs_malware()
    #files_difference_as_csv()
    plot_differences()